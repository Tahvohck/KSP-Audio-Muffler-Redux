using System;
using System.Collections.Generic;
using UnityEngine;
using System.Diagnostics;

namespace AudioMuffler
{
	/// <summary>
	/// Holds mapping of audio sources to the parts of current active vessel they are bound to.
	/// This allows to determine the corresponding part (if any) efficiently instead of iterating through
	/// all the vessel parts, thus improving performance in case of a high part count.
	/// </summary>
	public class VesselSoundsCache
	{

        // id is used to not mess with weak references to audio sources
        private Dictionary<int, Part> soundIDToPart = new Dictionary<int, Part>();
        //using a separate storage for internal model audio sources as they have completely different reference system
        private Dictionary<int, Part> soundIDToPartIVA = new Dictionary<int, Part>();

		public void RebuildCache(AudioSource[] audioSources) {
			Stopwatch performanceWatch = Stopwatch.StartNew();

			soundIDToPart.Clear();
			soundIDToPartIVA.Clear();
			for (int i = 0; i < audioSources.Length; i++) {
				AudioSource audioSource = audioSources[i];
				for (int p = 0; p < FlightGlobals.ActiveVessel.Parts.Count; p++) {
					Part part = FlightGlobals.ActiveVessel.Parts[p];
					if (part.internalModel && audioSource.transform.IsChildOf(part.internalModel.transform)) {
						soundIDToPartIVA.Add(audioSource.GetInstanceID(), part);
						break;
					} else if (audioSource.transform.IsChildOf(part.transform)) {
						soundIDToPart.Add(audioSource.GetInstanceID(), part);
						break;
					}
				}
			}
			/*foreach (KeyValuePair<int, Part> entry in soundIDToPart) {
				UnityEngine.Debug.Log("ENTRY: " + entry.Key + " " + entry.Value.name);
			}*/
			performanceWatch.Stop();
			KSPLog.print("AudioMuffler: VesselSoundsCache rebuild time = " + performanceWatch.ElapsedMilliseconds);
		}
		
		public Part GetPartFor(AudioSource audioSource) {
			Part part;
			return soundIDToPart.TryGetValue(audioSource.GetInstanceID(), out part) ? part : null;
		}

		public Part GetPartForIVA(AudioSource audioSource) {
			Part part;
			return soundIDToPartIVA.TryGetValue(audioSource.GetInstanceID(), out part) ? part : null;
		}
		
	}
}
